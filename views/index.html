<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp Bot</title>

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --surface: rgba(255, 255, 255, 0.85);
        --radius: 1.25rem;
      }

      /* p√°gina */
      /* ‚Ä¶ estilos anteriores ‚Ä¶ */

      body {
        /* 1Ô∏è‚É£  layout vertical  */
        display: flex;
        flex-direction: column; /* <‚Äî importante */
        min-height: 100vh; /* ocupa todo el alto */

        /* 2Ô∏è‚É£  fondo y fuente sin cambios */
        margin: 0;
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #e9f5ff 0%, #f4f8fb 50%, #fff 100%);
      }

      /* 3Ô∏è‚É£  centramos SOLO la tarjeta */
      main {
        flex: 1 0 auto; /* ocupa el espacio disponible */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem; /* el padding que ya ten√≠as */
      }

      /* 4Ô∏è‚É£  el footer se queda al fondo */
      footer {
        flex-shrink: 0; /* no se encoge */
        opacity: 0.6;
      }

      /* tarjeta de cristal */
      .glass-card {
        width: 100%;
        max-width: 1200px; /* m√°s ancha */
        background: var(--surface);
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
        border: 1px solid rgba(200, 200, 200, 0.25);
        border-radius: var(--radius);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }

      /* l√≠mite scroll mensajes */
      #lista-mensajes {
        max-height: 270px;
        overflow-y: auto;
      }

      /* spinner utilitario */
      .spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      /* QR responsivo */
      #qr-container img {
        max-width: 220px;
      }

      /* footer */
      footer {
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <main class="glass-card p-4">
      <!-- Cabecera general -->
      <body class="d-flex flex-column min-vh-100">
        <!-- Tarjeta principal -->
        <main
          class="glass-card flex-fill d-flex align-items-center justify-content-center p-4"
        >
          <div class="container-fluid">
            <!-- üëâ‚ÄÜpeque√±o wrapper para alinear todo -->

            <!-- Cabecera -->
            <header class="d-flex align-items-center gap-2 mb-4">
              <i class="bi bi-whatsapp fs-1 text-success"></i>
              <h1 class="h3 fw-bold mb-0">WhatsApp Bot</h1>
            </header>

            <!-- Contenido -->
            <div class="row gx-5 gy-4">
              <!--  g-x m√°s amplio -->
              <!-- Columna izquierda -->
              <aside class="col-12 col-md-5 col-lg-4">
                <!-- Estado / QR -->
                <div id="qr-container" class="small text-muted pb-3">
                  ‚è≥ Cargando QR‚Ä¶
                </div>

                <h2 class="h6 fw-semibold mb-2">
                  <i class="bi bi-pencil-square me-1"></i>Guardar mensaje
                </h2>
                <textarea
                  id="nuevo-mensaje"
                  class="form-control mb-2"
                  rows="3"
                  placeholder="Escribe tu mensaje aqu√≠‚Ä¶"
                ></textarea>
                <button
                  class="btn btn-primary w-100 mb-4"
                  onclick="guardarMensaje()"
                >
                  <i class="bi bi-save me-1"></i>Guardar
                </button>

                <h2 class="h6 fw-semibold mb-2">
                  <i class="bi bi-upload me-1"></i>Subir Excel
                </h2>
                <form
                  id="upload-form"
                  enctype="multipart/form-data"
                  class="d-grid gap-2"
                >
                  <input
                    type="file"
                    name="excel"
                    accept=".xlsx"
                    class="form-control"
                    required
                  />
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-send-check me-1"></i>Enviar Mensajes
                  </button>
                </form>
                <div id="envio-status" class="small text-center mt-2"></div>
              </aside>

              <!-- Columna derecha -->
              <section class="col-12 col-md-7 col-lg-8">
                <h2 class="h6 fw-semibold mb-2">
                  <i class="bi bi-card-list me-1"></i>Mensajes guardados
                </h2>
                <ul
                  id="lista-mensajes"
                  class="list-group list-group-flush border rounded"
                  style="max-height: 270px; overflow-y: auto"
                ></ul>
              </section>
            </div>
          </div>
        </main>

        <!-- Pie de p√°gina siempre abajo -->
        <footer class="text-center py-3 small opacity-50">
          &copy; <span id="year"></span> ‚Äì Bots Corp
        </footer>
      </body>
    </main>

    <footer class="w-100 text-center py-3 small">
      &copy; <span id="year"></span> ‚Äì Bots Corp
    </footer>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* a√±o din√°mico */
      document.getElementById("year").textContent = new Date().getFullYear();

      /* QR polling */
      async function mostrarQR() {
        const interval = setInterval(async () => {
          const res = await fetch("/qr");
          const data = await res.json();
          if (data.status === "qr") {
            document.getElementById(
              "qr-container"
            ).innerHTML = `<img src="${data.src}" alt="QR Code" class="img-thumbnail">`;
          } else if (data.status === "connected") {
            clearInterval(interval);
            document.getElementById("qr-container").innerHTML = `
  <div class="d-flex justify-content-between align-items-center">
    <span class="text-success fw-semibold">
      <i class="bi bi-check-circle-fill me-1"></i>WhatsApp conectado
    </span>
    <button class="btn btn-outline-danger btn-sm ms-3" onclick="desconectar()">
      <i class="bi bi-box-arrow-right me-1"></i>Desconectar
    </button>
  </div>
`;
          }
        }, 2000);
      }

      /* Guardar mensaje */
      async function guardarMensaje() {
        const texto = document.getElementById("nuevo-mensaje").value.trim();
        if (!texto) return;
        const res = await fetch("/mensajes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ texto }),
        });
        const result = await res.json();
        if (result.success) {
          document.getElementById("nuevo-mensaje").value = "";
          cargarMensajes();
        }
      }
      async function desconectar() {
        const confirmacion = confirm("¬øEst√°s seguro de cerrar sesi√≥n?");
        if (!confirmacion) return;

        const res = await fetch("/logout", { method: "POST" });
        const result = await res.json();

        if (result.success) {
          alert("Sesi√≥n cerrada exitosamente");
          location.reload(); // O: window.location.href = "/"; si quieres redirigir al men√∫
        } else {
          alert("Error al cerrar sesi√≥n");
        }
      }
      /* Cargar listado */
    async function cargarMensajes() {
  const res = await fetch("/mensajes");
  const mensajes = await res.json();
  const lista = document.getElementById("lista-mensajes");
  lista.innerHTML = "";

  mensajes.forEach((m) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span>${m.texto}</span>
      <button class="btn btn-sm btn-danger" onclick="eliminarMensaje(${m.id})">
        <i class="bi bi-trash"></i>
      </button>
    `;
    lista.appendChild(li);
  });
}
async function eliminarMensaje(id) {
  const confirmar = confirm("¬øEliminar este mensaje?");
  if (!confirmar) return;

  const res = await fetch(`/mensajes/${id}`, {
    method: "DELETE",
  });
  const result = await res.json();

  if (result.success) {
    cargarMensajes(); // actualiza la lista
  } else {
    alert("‚ùå No se pudo eliminar el mensaje");
  }
}


      /* Enviar Excel */
      document
        .getElementById("upload-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const status = document.getElementById("envio-status");
          status.innerHTML =
            '<span class="text-secondary"><i class="bi bi-arrow-repeat me-1 spin"></i>Enviando‚Ä¶</span>';
          const response = await fetch("/enviar-excel", {
            method: "POST",
            body: formData,
          });
          const result = await response.json();
          status.innerHTML = result.success
            ? '<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Mensajes enviados.</span>'
            : '<span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i>Error al enviar.</span>';
        });

      /* Init */
      mostrarQR();
      cargarMensajes();
    </script>
  </body>
</html>
